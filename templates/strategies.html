<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>策略管理 - Fin-Data-Maker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .main-container {
            padding: 2rem 0;
        }
        .card {
            border: none;
            box-shadow: 0 0 10px rgba(0,0,0,.05);
            margin-bottom: 1.5rem;
        }
        .card-header {
            background-color: #fff;
            border-bottom: 2px solid #e9ecef;
            font-weight: 600;
        }
        .strategy-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .strategy-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,.15);
        }
        .strategy-type-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .config-field {
            margin-bottom: 1rem;
        }
        .form-label {
            font-weight: 500;
            color: #495057;
        }
        .btn-create {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }
        .btn-create:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: white;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-database-fill"></i> Fin-Data-Maker
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">数据生成</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/strategies">策略管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">仪表盘</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/auth/logout">
                            <i class="bi bi-box-arrow-right"></i> 退出
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container main-container">
        <!-- 页面标题 -->
        <div class="row mb-4">
            <div class="col">
                <h2><i class="bi bi-gear-fill text-primary"></i> 自定义数据生成策略</h2>
                <p class="text-muted">创建和管理您的自定义数据生成策略，提升数据生成的灵活性</p>
            </div>
            <div class="col-auto">
                <button class="btn btn-create" data-bs-toggle="modal" data-bs-target="#createStrategyModal">
                    <i class="bi bi-plus-circle"></i> 创建新策略
                </button>
            </div>
        </div>

        <!-- 策略列表 -->
        <div class="row" id="strategiesList">
            <!-- 策略卡片将通过JavaScript动态加载 -->
        </div>

        <!-- 空状态提示 -->
        <div class="row d-none" id="emptyState">
            <div class="col-12 text-center py-5">
                <i class="bi bi-inbox" style="font-size: 4rem; color: #dee2e6;"></i>
                <h4 class="mt-3 text-muted">还没有创建任何策略</h4>
                <p class="text-muted">点击上方"创建新策略"按钮开始创建您的第一个策略</p>
            </div>
        </div>
    </div>

    <!-- 创建策略模态框 -->
    <div class="modal fade" id="createStrategyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">创建新策略</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createStrategyForm">
                        <div class="mb-3">
                            <label class="form-label">策略名称 *</label>
                            <input type="text" class="form-control" id="strategyName" required>
                            <small class="text-muted">为策略指定一个唯一的名称</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">策略类型 *</label>
                            <select class="form-select" id="strategyType" required>
                                <option value="">请选择...</option>
                            </select>
                            <small class="text-muted" id="strategyTypeDesc"></small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">策略描述</label>
                            <textarea class="form-control" id="strategyDescription" rows="2"></textarea>
                        </div>

                        <div id="configFields">
                            <!-- 根据策略类型动态生成配置字段 -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="createStrategy()">创建策略</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑策略模态框 -->
    <div class="modal fade" id="editStrategyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑策略</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editStrategyForm">
                        <input type="hidden" id="editStrategyName">

                        <div class="mb-3">
                            <label class="form-label">策略名称</label>
                            <input type="text" class="form-control" id="editStrategyNameDisplay" disabled>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">策略类型</label>
                            <input type="text" class="form-control" id="editStrategyType" disabled>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">策略描述</label>
                            <textarea class="form-control" id="editStrategyDescription" rows="2"></textarea>
                        </div>

                        <div id="editConfigFields">
                            <!-- 根据策略类型动态生成配置字段 -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="updateStrategy()">保存修改</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let strategyTypes = [];
        let strategies = [];

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadStrategyTypes();
            loadStrategies();
        });

        // 加载策略类型
        async function loadStrategyTypes() {
            try {
                const response = await fetch('/api/strategies/types');
                const result = await response.json();

                if (result.success) {
                    strategyTypes = result.data;

                    // 填充策略类型下拉列表
                    const select = document.getElementById('strategyType');
                    strategyTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.value;
                        option.textContent = type.label;
                        option.dataset.description = type.description;
                        option.dataset.fields = JSON.stringify(type.config_fields);
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('加载策略类型失败:', error);
            }
        }

        // 策略类型改变时更新描述和配置字段
        document.getElementById('strategyType').addEventListener('change', function() {
            const option = this.options[this.selectedIndex];
            const description = option.dataset.description || '';
            const fields = JSON.parse(option.dataset.fields || '[]');

            document.getElementById('strategyTypeDesc').textContent = description;
            generateConfigFields('configFields', fields);
        });

        // 生成配置字段
        function generateConfigFields(containerId, fields) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (fields.length === 0) {
                return;
            }

            const title = document.createElement('h6');
            title.className = 'border-top pt-3 mt-3';
            title.textContent = '配置参数';
            container.appendChild(title);

            fields.forEach(field => {
                const div = document.createElement('div');
                div.className = 'config-field';

                const label = document.createElement('label');
                label.className = 'form-label';
                label.textContent = getFieldLabel(field);

                const input = createInputForField(field);
                input.id = `config_${field}`;
                input.className = 'form-control';

                div.appendChild(label);
                div.appendChild(input);

                const help = document.createElement('small');
                help.className = 'text-muted';
                help.textContent = getFieldHelp(field);
                div.appendChild(help);

                container.appendChild(div);
            });
        }

        // 创建输入字段
        function createInputForField(field) {
            if (field === 'choices' || field === 'weights' || field === 'conditions' || field === 'mapping') {
                const textarea = document.createElement('textarea');
                textarea.rows = 3;
                textarea.placeholder = 'JSON格式，例如: ["选项1", "选项2"]';
                return textarea;
            } else if (field === 'expression') {
                const textarea = document.createElement('textarea');
                textarea.rows = 2;
                textarea.placeholder = '例如: context.row_index * 100';
                return textarea;
            } else if (field.includes('type')) {
                const select = document.createElement('select');
                const options = getTypeOptions(field);
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.label;
                    select.appendChild(option);
                });
                return select;
            } else {
                return document.createElement('input');
            }
        }

        // 获取字段标签
        function getFieldLabel(field) {
            const labels = {
                'start': '起始值',
                'step': '步长',
                'format': '格式字符串',
                'min_value': '最小值',
                'max_value': '最大值',
                'data_type': '数据类型',
                'precision': '精度',
                'choices': '选项列表',
                'weights': '权重列表',
                'conditions': '条件列表',
                'default': '默认值',
                'source_field': '源字段',
                'mapping': '映射关系',
                'calculation': '计算方式',
                'factor': '因子',
                'start_date': '起始日期',
                'end_date': '结束日期',
                'date_format': '日期格式',
                'sequential': '顺序生成',
                'step_days': '步长天数',
                'expression': 'Python表达式',
                'distribution_type': '分布类型',
                'mean': '均值',
                'std_dev': '标准差',
                'lambda_param': 'Lambda参数',
                'round_to_int': '四舍五入为整数'
            };
            return labels[field] || field;
        }

        // 获取字段帮助文本
        function getFieldHelp(field) {
            const helps = {
                'format': '例如: "ID_{:05d}" 生成 ID_00001',
                'data_type': '选择生成的数据类型',
                'choices': 'JSON数组，例如: ["A", "B", "C"]',
                'weights': 'JSON数组，与choices对应，例如: [0.5, 0.3, 0.2]',
                'conditions': 'JSON数组，包含条件对象',
                'calculation': 'multiply/divide/add/subtract/percentage',
                'start_date': '格式: YYYY-MM-DD 或 today',
                'date_format': '默认: %Y-%m-%d',
                'expression': '可访问context对象，例如: context.row_index',
                'distribution_type': 'normal/uniform/exponential/poisson'
            };
            return helps[field] || '';
        }

        // 获取类型选项
        function getTypeOptions(field) {
            if (field === 'data_type') {
                return [
                    {value: 'int', label: '整数'},
                    {value: 'float', label: '浮点数'},
                    {value: 'decimal', label: '小数'}
                ];
            } else if (field === 'distribution_type') {
                return [
                    {value: 'normal', label: '正态分布'},
                    {value: 'uniform', label: '均匀分布'},
                    {value: 'exponential', label: '指数分布'},
                    {value: 'poisson', label: '泊松分布'}
                ];
            } else if (field === 'calculation') {
                return [
                    {value: 'multiply', label: '乘法'},
                    {value: 'divide', label: '除法'},
                    {value: 'add', label: '加法'},
                    {value: 'subtract', label: '减法'},
                    {value: 'percentage', label: '百分比'}
                ];
            }
            return [];
        }

        // 收集配置值
        function collectConfig(containerId) {
            const container = document.getElementById(containerId);
            const config = {};
            const inputs = container.querySelectorAll('[id^="config_"]');

            inputs.forEach(input => {
                const field = input.id.replace('config_', '');
                let value = input.value;

                if (!value) return;

                // 尝试解析JSON
                if (input.tagName === 'TEXTAREA' && (field === 'choices' || field === 'weights' || field === 'conditions' || field === 'mapping')) {
                    try {
                        value = JSON.parse(value);
                    } catch (e) {
                        console.warn(`无法解析 ${field} 的JSON值`);
                    }
                } else if (field.includes('value') || field === 'step' || field === 'precision' || field === 'mean' || field === 'std_dev' || field === 'lambda_param' || field === 'factor' || field === 'step_days') {
                    value = Number(value);
                } else if (field === 'sequential' || field === 'round_to_int') {
                    value = input.checked;
                }

                config[field] = value;
            });

            return config;
        }

        // 创建策略
        async function createStrategy() {
            const name = document.getElementById('strategyName').value.trim();
            const type = document.getElementById('strategyType').value;
            const description = document.getElementById('strategyDescription').value.trim();

            if (!name || !type) {
                alert('请填写策略名称和类型');
                return;
            }

            const config = collectConfig('configFields');

            try {
                const response = await fetch('/api/strategies', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, type, description, config})
                });

                const result = await response.json();

                if (result.success) {
                    alert('策略创建成功！');
                    bootstrap.Modal.getInstance(document.getElementById('createStrategyModal')).hide();
                    document.getElementById('createStrategyForm').reset();
                    loadStrategies();
                } else {
                    alert('创建失败: ' + result.message);
                }
            } catch (error) {
                console.error('创建策略失败:', error);
                alert('创建失败，请稍后重试');
            }
        }

        // 加载策略列表
        async function loadStrategies() {
            try {
                const response = await fetch('/api/strategies');
                const result = await response.json();

                if (result.success) {
                    strategies = result.data;
                    displayStrategies();
                }
            } catch (error) {
                console.error('加载策略失败:', error);
            }
        }

        // 显示策略列表
        function displayStrategies() {
            const container = document.getElementById('strategiesList');
            const emptyState = document.getElementById('emptyState');

            if (strategies.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('d-none');
                return;
            }

            emptyState.classList.add('d-none');
            container.innerHTML = '';

            strategies.forEach(strategy => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4';

                const typeInfo = strategyTypes.find(t => t.value === strategy.type) || {label: strategy.type};

                col.innerHTML = `
                    <div class="card strategy-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">${strategy.name}</h5>
                                <span class="badge bg-primary strategy-type-badge">${typeInfo.label}</span>
                            </div>
                            <p class="card-text text-muted small">${strategy.description || '无描述'}</p>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="editStrategy('${strategy.name}')">
                                    <i class="bi bi-pencil"></i> 编辑
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteStrategy('${strategy.name}')">
                                    <i class="bi bi-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                container.appendChild(col);
            });
        }

        // 编辑策略
        function editStrategy(name) {
            const strategy = strategies.find(s => s.name === name);
            if (!strategy) return;

            document.getElementById('editStrategyName').value = strategy.name;
            document.getElementById('editStrategyNameDisplay').value = strategy.name;
            document.getElementById('editStrategyType').value = strategyTypes.find(t => t.value === strategy.type)?.label || strategy.type;
            document.getElementById('editStrategyDescription').value = strategy.description || '';

            const typeInfo = strategyTypes.find(t => t.value === strategy.type);
            if (typeInfo) {
                generateConfigFields('editConfigFields', typeInfo.config_fields);

                // 填充现有配置值
                Object.entries(strategy.config || {}).forEach(([key, value]) => {
                    const input = document.getElementById(`config_${key}`);
                    if (input) {
                        if (typeof value === 'object') {
                            input.value = JSON.stringify(value);
                        } else {
                            input.value = value;
                        }
                    }
                });
            }

            new bootstrap.Modal(document.getElementById('editStrategyModal')).show();
        }

        // 更新策略
        async function updateStrategy() {
            const name = document.getElementById('editStrategyName').value;
            const description = document.getElementById('editStrategyDescription').value.trim();
            const config = collectConfig('editConfigFields');

            try {
                const response = await fetch(`/api/strategies/${name}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({description, config})
                });

                const result = await response.json();

                if (result.success) {
                    alert('策略更新成功！');
                    bootstrap.Modal.getInstance(document.getElementById('editStrategyModal')).hide();
                    loadStrategies();
                } else {
                    alert('更新失败: ' + result.message);
                }
            } catch (error) {
                console.error('更新策略失败:', error);
                alert('更新失败，请稍后重试');
            }
        }

        // 删除策略
        async function deleteStrategy(name) {
            if (!confirm(`确定要删除策略"${name}"吗？`)) {
                return;
            }

            try {
                const response = await fetch(`/api/strategies/${name}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('策略删除成功！');
                    loadStrategies();
                } else {
                    alert('删除失败: ' + result.message);
                }
            } catch (error) {
                console.error('删除策略失败:', error);
                alert('删除失败，请稍后重试');
            }
        }
    </script>
</body>
</html>
