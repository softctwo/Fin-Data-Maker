<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据质量仪表板 - Fin-Data-Maker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 30px;
        }
        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .navbar-brand {
            font-weight: bold;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stat-card h3 {
            font-size: 2rem;
            margin: 0;
        }
        .stat-card p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-database-fill-gear"></i> Fin-Data-Maker
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">数据生成</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/dashboard">数据仪表板</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/batch">批量处理</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/auth/logout">
                            <i class="bi bi-box-arrow-right"></i> 登出
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2 class="mb-4">
            <i class="bi bi-graph-up"></i> 数据质量仪表板
        </h2>

        <!-- 统计卡片 -->
        <div class="row">
            <div class="col-md-3">
                <div class="stat-card">
                    <h3 id="stat-total-tables">0</h3>
                    <p>已分析表</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h3 id="stat-total-records">0</h3>
                    <p>已生成记录</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <h3 id="stat-avg-quality">0%</h3>
                    <p>平均质量得分</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <h3 id="stat-batch-tasks">0</h3>
                    <p>批量任务</p>
                </div>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="row">
            <!-- 历史趋势图 -->
            <div class="col-md-12">
                <div class="chart-card">
                    <h5>
                        <i class="bi bi-graph-up-arrow"></i> 操作历史趋势（最近7天）
                    </h5>
                    <div class="chart-container">
                        <canvas id="historyTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 数据质量总览 -->
            <div class="col-md-8">
                <div class="chart-card">
                    <h5>
                        <i class="bi bi-bar-chart-fill"></i> 数据质量总览（最近10次分析）
                    </h5>
                    <div class="chart-container">
                        <canvas id="qualityOverviewChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 选择表查看详情 -->
            <div class="col-md-4">
                <div class="chart-card">
                    <h5>
                        <i class="bi bi-table"></i> 选择表查看详情
                    </h5>
                    <div class="mb-3">
                        <label class="form-label">选择表:</label>
                        <select class="form-select" id="tableSelect">
                            <option value="">-- 请选择 --</option>
                        </select>
                    </div>
                    <button class="btn btn-primary w-100" id="loadTableChartsBtn">
                        <i class="bi bi-graph-up"></i> 加载图表
                    </button>
                </div>
            </div>

            <!-- 字段完整性图表 -->
            <div class="col-md-6" id="fieldCompletenessCard" style="display: none;">
                <div class="chart-card">
                    <h5>
                        <i class="bi bi-pie-chart-fill"></i> 字段完整性分布
                    </h5>
                    <div class="chart-container">
                        <canvas id="fieldCompletenessChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 质量雷达图 -->
            <div class="col-md-6" id="qualityRadarCard" style="display: none;">
                <div class="chart-card">
                    <h5>
                        <i class="bi bi-diagram-3-fill"></i> 数据质量雷达图
                    </h5>
                    <div class="chart-container">
                        <canvas id="qualityRadarChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let historyTrendChart, qualityOverviewChart, fieldCompletenessChart, qualityRadarChart;

        // 加载统计数据
        async function loadStats() {
            try {
                // 加载历史统计
                const histRes = await fetch('/api/histories/stats');
                const histData = await histRes.json();

                if (histData.success) {
                    const byType = histData.data.by_type;
                    document.getElementById('stat-total-tables').textContent = byType.profile || 0;
                    document.getElementById('stat-total-records').textContent = byType.generate || 0;
                }

                // 加载批量任务统计
                const batchRes = await fetch('/api/batch/list?per_page=1000');
                const batchData = await batchRes.json();

                if (batchData.success) {
                    document.getElementById('stat-batch-tasks').textContent = batchData.total || 0;
                }

                // 加载质量总览（用于计算平均质量）
                const qualityRes = await fetch('/api/charts/quality-overview');
                const qualityData = await qualityRes.json();

                if (qualityData.success && qualityData.data.completeness.length > 0) {
                    const avgQuality = qualityData.data.completeness.reduce((a, b) => a + b, 0) / qualityData.data.completeness.length;
                    document.getElementById('stat-avg-quality').textContent = Math.round(avgQuality) + '%';
                }

            } catch (error) {
                console.error('加载统计数据失败:', error);
            }
        }

        // 加载历史趋势图
        async function loadHistoryTrend() {
            try {
                const response = await fetch('/api/charts/history-trend?days=7');
                const result = await response.json();

                if (!result.success) {
                    console.error('加载历史趋势失败:', result.message);
                    return;
                }

                const data = result.data;

                if (historyTrendChart) {
                    historyTrendChart.destroy();
                }

                const ctx = document.getElementById('historyTrendChart').getContext('2d');
                historyTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: '连接',
                                data: data.datasets.connect,
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: '生成',
                                data: data.datasets.generate,
                                borderColor: 'rgb(153, 102, 255)',
                                backgroundColor: 'rgba(153, 102, 255, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: '导出',
                                data: data.datasets.export,
                                borderColor: 'rgb(255, 159, 64)',
                                backgroundColor: 'rgba(255, 159, 64, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: '分析',
                                data: data.datasets.profile,
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('加载历史趋势图失败:', error);
            }
        }

        // 加载数据质量总览
        async function loadQualityOverview() {
            try {
                const response = await fetch('/api/charts/quality-overview');
                const result = await response.json();

                if (!result.success) {
                    console.error('加载质量总览失败:', result.message);
                    return;
                }

                const data = result.data;

                if (qualityOverviewChart) {
                    qualityOverviewChart.destroy();
                }

                const ctx = document.getElementById('qualityOverviewChart').getContext('2d');
                qualityOverviewChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: '完整性 (%)',
                                data: data.completeness,
                                backgroundColor: 'rgba(75, 192, 192, 0.8)',
                            },
                            {
                                label: '唯一性 (%)',
                                data: data.uniqueness,
                                backgroundColor: 'rgba(153, 102, 255, 0.8)',
                            },
                            {
                                label: '有效性 (%)',
                                data: data.validity,
                                backgroundColor: 'rgba(255, 159, 64, 0.8)',
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });

                // 填充表选择下拉框
                const tableSelect = document.getElementById('tableSelect');
                tableSelect.innerHTML = '<option value="">-- 请选择 --</option>';
                data.labels.forEach(table => {
                    const option = document.createElement('option');
                    option.value = table;
                    option.textContent = table;
                    tableSelect.appendChild(option);
                });

            } catch (error) {
                console.error('加载质量总览失败:', error);
            }
        }

        // 加载字段完整性图表
        async function loadFieldCompleteness(tableName) {
            try {
                const response = await fetch(`/api/charts/field-completeness/${tableName}`);
                const result = await response.json();

                if (!result.success) {
                    alert(result.message);
                    return;
                }

                const data = result.data;

                if (fieldCompletenessChart) {
                    fieldCompletenessChart.destroy();
                }

                const ctx = document.getElementById('fieldCompletenessChart').getContext('2d');
                fieldCompletenessChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            data: data.data,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.8)',
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(255, 206, 86, 0.8)',
                                'rgba(75, 192, 192, 0.8)',
                                'rgba(153, 102, 255, 0.8)',
                                'rgba(255, 159, 64, 0.8)',
                                'rgba(199, 199, 199, 0.8)',
                                'rgba(83, 102, 255, 0.8)',
                                'rgba(255, 99, 255, 0.8)',
                                'rgba(99, 255, 132, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                            },
                            title: {
                                display: false
                            }
                        }
                    }
                });

                document.getElementById('fieldCompletenessCard').style.display = 'block';

            } catch (error) {
                console.error('加载字段完整性图表失败:', error);
                alert('加载失败: ' + error.message);
            }
        }

        // 加载质量雷达图
        async function loadQualityRadar(tableName) {
            try {
                const response = await fetch(`/api/charts/quality-radar/${tableName}`);
                const result = await response.json();

                if (!result.success) {
                    alert(result.message);
                    return;
                }

                const data = result.data;

                if (qualityRadarChart) {
                    qualityRadarChart.destroy();
                }

                const ctx = document.getElementById('qualityRadarChart').getContext('2d');
                qualityRadarChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: '质量得分',
                            data: data.data,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgb(54, 162, 235)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgb(54, 162, 235)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgb(54, 162, 235)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });

                document.getElementById('qualityRadarCard').style.display = 'block';

            } catch (error) {
                console.error('加载质量雷达图失败:', error);
                alert('加载失败: ' + error.message);
            }
        }

        // 加载表详情图表
        document.getElementById('loadTableChartsBtn').addEventListener('click', () => {
            const tableName = document.getElementById('tableSelect').value;
            if (!tableName) {
                alert('请先选择表');
                return;
            }

            loadFieldCompleteness(tableName);
            loadQualityRadar(tableName);
        });

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadHistoryTrend();
            loadQualityOverview();
        });
    </script>
</body>
</html>
